version: v1.0
name: my-zivi
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
auto_cancel:
  running:
    when: 'true'
fail_fast:
  cancel:
    when: "branch != 'master' AND branch != 'develop'"
blocks:
  - name: Cache
    execution_time_limit:
      minutes: 10
    dependencies: []
    task:
      secrets:
        - name: my-zivi
      jobs:
        - name: cache
          priority:
            - value: 70
              when: "branch = 'master'"
            - value: 60
              when: "branch = 'develop'"
            - value: 50
              when: true
          commands:
            - 'cache restore gems-gemfile-lock-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-develop'
            - 'cache restore node-modules-yarn-lock-$(checksum yarn.lock),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules-develop'
            - 'cache restore nvm-nvmrc-$(checksum .nvmrc),nvm-$SEMAPHORE_GIT_BRANCH,nvm-develop'
            - bundle install --deployment -j 4 --path vendor/bundle
            - nvm install
            - bin/yarn install --cache-folder ~/.cache/yarn
            - cache store gems-gemfile-lock-$(checksum Gemfile.lock) vendor/bundle
            - cache store gems-$SEMAPHORE_GIT_BRANCH vendor/bundle
            - cache store node-modules-yarn-lock-$(checksum yarn.lock) ~/.cache/yarn
            - cache store node-modules-$SEMAPHORE_GIT_BRANCH ~/.cache/yarn
            - cache store nvm-nvmrc-$(checksum .nvmrc) $HOME/.nvm
            - cache store nvm-$SEMAPHORE_GIT_BRANCH $HOME/.nvm
      prologue:
        commands:
          - checkout --use-cache
  - name: Tests
    execution_time_limit:
      minutes: 10
    dependencies:
      - Cache
    task:
      secrets:
        - name: my-zivi
      env_vars:
        - name: DATABASE_URL
          value: 'postgresql://postgres@localhost/test?encoding=utf8'
        - name: RAILS_ENV
          value: test
        - name: TZ
          value: Europe/Zurich
        - name: APP_HOST
          value: example.com
      prologue:
        commands:
          - checkout --use-cache
          - 'cache restore gems-gemfile-lock-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-develop'
          - 'cache restore node-modules-yarn-lock-$(checksum yarn.lock),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules-develop'
          - 'cache restore nvm-nvmrc-$(checksum .nvmrc),nvm-$SEMAPHORE_GIT_BRANCH,nvm-develop'
          - bundle install --deployment -j 4 --path vendor/bundle
          - nvm install
          - bin/yarn install --cache-folder ~/.cache/yarn
      jobs:
        - name: Lint
          priority:
            - value: 70
              when: "branch = 'master'"
            - value: 60
              when: "branch = 'develop'"
            - value: 50
              when: true
          commands:
            - bin/lint
        - name: Unit Tests
          priority:
            - value: 70
              when: "branch = 'master'"
            - value: 60
              when: "branch = 'develop'"
            - value: 50
              when: true
          commands:
            - sem-service start postgres 12
            - 'bundle exec rails db:create db:structure:load'
            - bin/unit-tests
        - name: JavaScript Tests
          priority:
            - value: 70
              when: "branch = 'master'"
            - value: 60
              when: "branch = 'develop'"
            - value: 50
              when: true
          commands:
            - yarn test
        - name: System Tests
          priority:
            - value: 70
              when: "branch = 'master'"
            - value: 60
              when: "branch = 'develop'"
            - value: 50
              when: true
          commands:
            - sem-service start postgres 12
            - 'bundle exec rails db:create db:structure:load'
            - bin/system-tests
      epilogue:
        on_fail:
          commands:
            - artifact push job log/test.log
            - artifact push job screenshots
  - name: Percy
    dependencies:
      - Tests
    task:
      secrets:
        - name: my-zivi
      env_vars:
        - name: DATABASE_URL
          value: 'postgresql://postgres@localhost/test?encoding=utf8'
        - name: RAILS_ENV
          value: test
        - name: APP_HOST
          value: example.com
      prologue:
        commands:
          - checkout --use-cache
          - 'cache restore gems-gemfile-lock-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-develop'
          - 'cache restore node-modules-yarn-lock-$(checksum yarn.lock),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules-develop'
          - 'cache restore nvm-nvmrc-$(checksum .nvmrc),nvm-$SEMAPHORE_GIT_BRANCH,nvm-develop'
          - bundle install --deployment -j 4 --path vendor/bundle
          - nvm install
          - bin/yarn install --cache-folder ~/.cache/yarn
          - sudo apt-get update
          - sudo apt-get install libxss1
          - sem-service start postgres 12
          - 'bundle exec rails db:create db:structure:load'
      jobs:
        - name: Capture Screenshots
          priority:
            - value: 70
              when: "branch = 'master'"
            - value: 60
              when: "branch = 'develop'"
            - value: 50
              when: true
          commands:
            - NO_COVERAGE=true yarn run percy:capture-screenshots
      epilogue:
        on_fail:
          commands:
            - artifact push job log/test.log
            - artifact push job screenshots
  - name: Performance Check
    dependencies:
      - Cache
    run:
      when: "branch = 'master' OR branch = 'develop'"
    task:
      secrets:
        - name: my-zivi
      env_vars:
        - name: DATABASE_URL
          value: 'postgresql://postgres@localhost/test?encoding=utf8'
        - name: RAILS_ENV
          value: production
        - name: RAILS_SERVE_STATIC_FILES
          value: 'true'
        - name: SECRET_KEY_BASE
          value: 50490f620b684654c2d1232a16852620e20fee34f5bc38e56b66f73a2d57504d037be521387feceedac58e7cc725f292c4c3cbda3bd5977fcd7ae2748c4c27f7
        - name: APP_HOST
          value: example.com
      prologue:
        commands:
          - checkout --use-cache
          - 'cache restore gems-gemfile-lock-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-develop'
          - 'cache restore node-modules-yarn-lock-$(checksum yarn.lock),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules-develop'
          - 'cache restore nvm-nvmrc-$(checksum .nvmrc),nvm-$SEMAPHORE_GIT_BRANCH,nvm-develop'
          - bundle install --deployment -j 4 --path vendor/bundle
          - nvm install
          - bin/yarn install --cache-folder ~/.cache/yarn
          - sudo apt-get update
          - sudo apt-get install libxss1
          - bin/rake assets:precompile
          - sem-service start postgres 12
          - 'bundle exec rails db:create db:structure:load'
      jobs:
        - name: Lighthouse CI
          commands:
            - lhci autorun
