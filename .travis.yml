language: php
sudo: false
php:
  - 7.1

stages:
  - test
  - name: deploy
    if: branch = master OR branch = production OR branch =~ \b-DEPLOY\b OR branch = ts

cache:
  directories:
    - $HOME/.composer/cache/files
    - $HOME/.cache/yarn
    - $HOME/.cache/Cypress

# install programming languages
before_install:
  - nvm install 10

install:
  - composer install -d api $COMPOSER_FLAGS
  - npm install -g yarn
  - yarn --cwd frontend install

jobs:
  include:
    # run the test steps
    - stage: test
      script: ./ci/test_backend.sh
      name: "Run automated tests for backend"
    - script: ./ci/check_format.sh
      name: "Check formatting of front- and backend"

    # run the deployment step
    - stage: deploy
      script: skip
      env:
      - DEPLOY_SYSTEM: $(if [ "$TRAVIS_BRANCH" == "production" ]; then echo "prod"; else echo "test"; fi)
      deploy:
      - provider: script
        script: ci/deploy.sh $DEPLOY_SYSTEM
        skip_cleanup: true
        on:
          all_branches: true

env:
  global:
    secure: "PST5xGuQ5iE3FqkayeHtn6/O4rvACvZrTm1wzWVkDrE/KUnrko5H9UwNixPVSyeL2mr+fT163ZuYVkXQ/Ps6ZxYuFy/9/gmF9xDfxp1sfBc5jpXX7qUlmtMvsO0Z7qb7IMr+GKUW3dfnhldotQYIAbS3F0+9WmfejSollajj3SQmoe93fSUBSWKuuRwdv0V5CRf0iuA8WuJMLiIhclD/Uqu2+vp1tbUc2Dnw5O57YRSvfuSgXzm0N4oX0WyMhLhgjKEP2P/2Atd0RisrO2RGkUovRa6C+R+x/0WbKi/KEpktOxS34JYosby1oCP2XnvOSuiCDdsPH036kQQDogMD/hQccxYcpVYcjrqybjVIVLfSlGcpmy9QILCuDcc4D/uYOm7NA2ExtssqjiMAwaMqiriOoDeNfWK73yUnWuErKQbaxyDd2Aix1ZCaET0OcolN26KqsmyJ+pYD2Kd5zlmn9sWT0fZ9sAlOLdPDS+RkrHnUo0EXLgGYrZF0g0Yod0sVNMs6EQwm8rMDI6PvYX0lBPafi8v485L4bk2hP3tHcfE3X70GDciUanYdbm0+KdYzocVO3f2Ra08HXxwDEgILrw3G6FzR3ZQkdasTRM1by9zlCNjYT76/qU0H7DMLCh8cke/zbAnPxbiTEdZsEc4caBG3xFevhG4IfqgupwszzEk="
notifications:
  slack:
    secure: TOZNOUzZHJrb7OjU/QgD2idWqUay7+m/y0spsVzRqGA1Rko7qqvj5+/T5tSeL/0+a9i3jRctC8ExR9x8KwwZbYwjNfENmgAATGaqQKBPuOoaNjPunRTOWC+YvdZbNEYVBrC/YvdIbhfrpj/tg8oLxVFvR94TbjFgP06wUi1g/KbFl/zRv/4C/ERhJsiaC2Qt38HKhx6CAJt76rnMXWIngDdMFT5TaJjtHzsip7BW9+A3lNWTpJppVx8LGstSqiIMGCtG1kofCxUpCGFZz39uE4Wq/LxzjQSdx8kzLyyx6MK1LvQhM4Qv0FjLS5HxZe6glym7aT63/jPvxnZy0YI6MRA7sI6FW2yG+zdNyXeHFxrIUt3690597Q/tfiQGWOIZXk9KqyZPQzwO0KXznM/eZGVYuI0BPx64DOz8G3kkgYPJ1wcLs7cDehcTJhsAOTrYakZ3lJ4YP8EGztawbImw46uzIOeunF32My+vC0God7otOoI+uCpJOmI9d7e9Ty907n6cfBvslMSZ94PglfAKHa8HbxLOq5n/6TM6efjWkFj+ZK4Kb94ikMpX4qL9UKvDaKi9269x/1FHKSSR+GaNbVyeTeziL4TYP5YuoBI9qW7wkmR9+3UzTNqKwvPpvvdLH5D/alif97t4NiD/GMYG4IONtl64jyPh9a9Mty38twA=
